CREATE DATABASE CONSTRUCTORA

USE CONSTRUCTORA

CREATE TABLE CONDUCTORES(
COD_COND CHAR(3) PRIMARY KEY CHECK (COD_COND LIKE 'C[0-9][0-9]') NOT NULL,
NOMBRE VARCHAR(50) NOT NULL,
LOCALIDAD VARCHAR(50) NOT NULL,
CATEGORIA INT NOT NULL
);

CREATE TABLE MAQUINAS(
COD_MAQ CHAR(3) PRIMARY KEY CHECK (COD_MAQ LIKE 'M[0-9][0-9]') NOT NULL,
NOMBRE VARCHAR(60) NOT NULL,
PRECIO_HORA MONEY DEFAULT(00) NOT NULL
);

CREATE TABLE PROYECTOS(
COD_PROY CHAR(3) PRIMARY KEY CHECK (COD_PROY LIKE 'P[0-9][0-9]') NOT NULL,
DESCRIPCION VARCHAR(200) DEFAULT('El PROYECTO NO TIENE DESCRIPCION'),
LOCALIDAD VARCHAR(100) NULL,
CLIENTE VARCHAR(80) NOT NULL
);

CREATE TABLE TRABAJOS(
COD_CONDUCTOR CHAR(3) NOT NULL FOREIGN KEY REFERENCES CONDUCTORES(COD_COND),
COD_MAQUINA CHAR(3) NOT NULL FOREIGN KEY REFERENCES MAQUINAS(COD_MAQ),
COD_PROYECTO CHAR(3) NOT NULL FOREIGN KEY REFERENCES PROYECTOS(COD_PROY),
FECHA DATE NOT NULL,
TIEMPO INT NOT NULL,
);

INSERT INTO CONDUCTORES VALUES
('C01','JOSE SANCHEZ','JORGE CHAVEZ',18),
('C02','MANUEL DIAZ','JORGE CHAVEZ',15),
('C03','JUAN PEREZ ','CRISTO REY',20),
('C04','LUIS ORTIZ','JORGE CHAVEZ',18),
('C05','JAVIER MARTIN','15 DE AGOSTO',12)

INSERT INTO MAQUINAS VALUES 
('M01','EXCAVADORA',15000),
('M02','HORMIGONERA',20000),
('M03','VOLQUETE',10000)

INSERT INTO PROYECTOS VALUES 
('P01','REFORMA VIVIENDA','JORGE CHAVEZ','FELIPE GARCIA'),
('P02','CONSTRUCCION CIVIL','CRISTO REY','PEDRO MARTINEZ'),
('P03','REFORMA VIVIENDA','JORGE CHAVEZ','ROSA ALVAREZ'),
('P04','CONSTRUCCION PARQUES','15 DE AGOSTO','FERMIN BLANCO'),
('P05','ALICATAR SUELO','JORGE CHAVEZ','MARIA MARTINEZ')

INSERT INTO TRABAJOS VALUES
('C02','M03','P01','2021-06-10',100),
('C03','M01','P02','2021-06-10',200),
('C05','M03','P02','2021-06-10',150),
('C04','M03','P02','2021-06-10',90),
('C01','M02','P02','2021-06-12',120),
('C02','M03','P03','2021-06-13',30),
('C03','M01','P04','2021-06-15',300),
('C02','M03','P02','2021-06-15',45),
('C03','M03','P04','2021-06-15',180),
('C02','M03','P04','2021-06-15',90),
('C01','M02','P04','2021-06-17',120),
('C05','M03','P01','2021-06-18',35)

SELECT * FROM TRABAJOS
SELECT * FROM CONDUCTORES
SELECT * FROM MAQUINAS
SELECT * FROM PROYECTOS

--------------------------------------CONSULTAS------------------------------------------------------------------------

--3.	Buscar los Clientes Que empiecen con F

SELECT * FROM PROYECTOS WHERE CLIENTE LIKE 'F%' 

--4.	Agregar  el campo Descuento a  la tabla Máquinas

ALTER TABLE MAQUINAS
ADD DESCUENTO MONEY;

--5. Calcular  el Descuento del 5% del precio_Hora de la excavadora 

SELECT COD_MAQ, NOMBRE, PRECIO_HORA AS 'PRECIO POR HORA NORMAL',
	PRECIO_HORA * 5/100 AS 'DESCUENTO DEL 5% DEL PRECIO POR HORA'
FROM MAQUINAS WHERE NOMBRE = 'EXCAVADORA'
                                                                                                                               
--6. Hacer una consulta donde el Proyecto  sea Cristo Rey

SELECT * FROM PROYECTOS 
WHERE LOCALIDAD = 'CRISTO REY'

/*7. Insertar un nuevo Proyecto cuyos valores son:
CODPROY	Decripción	LOCALIDAD	CLIENTE
P06	Construcción Puente,	Puente Prolong Mariscal  Castilla, 	Rodriguez Banda*/

INSERT INTO PROYECTOS VALUES
('P06','CONSTRUCCION PUENTE','PUENTE PROLONG MARISCAL CASTILLA','RODRIGUEZ BANDA')

SELECT * FROM PROYECTOS

--8. Incrementar el precio_hora de todas las máquinas en un 4.5 %

SELECT COD_MAQ, NOMBRE, PRECIO_HORA AS 'PRECIO POR HORA NORMAL',
	(PRECIO_HORA * 4.5/100) + PRECIO_HORA AS 'INCREMENTEO DEL 4.5% DEL PRECIO POR HORA'
FROM MAQUINAS

--9. Obtener la máxima fecha y el mínimo tiempo y la suma y  media del tiempo de la tabla trabajos

SELECT * FROM TRABAJOS

SELECT MAX(FECHA) AS 'MAXIMA FECHA' FROM TRABAJOS;
SELECT MIN(TIEMPO) AS 'TIEMPO MINIMO' FROM TRABAJOS;
SELECT SUM(TIEMPO) AS 'SUMA DE TIEMPO' FROM TRABAJOS;
SELECT SUM(TIEMPO) / COUNT(TIEMPO) AS 'MEDIA DE TIEMPO' FROM TRABAJOS;

--10. Eliminar de la base de datos el conductor Luis Ortiz

DELETE FROM CONDUCTORES 
WHERE NOMBRE = 'LUIS ORTIZ'

/*11. Para evitar que la eliminación  anterior provoque una inconsistencia deberá eliminar también en la tabla trabajos 
el registro que vincula dicho conductor.*/
 
DELETE FROM TRABAJOS			--ESTA LINEA DE CODIGO ES LA QUE DEVE DE EJECUTAR ANTES DE LA DEL EJERCICIO 10
WHERE COD_CONDUCTOR = 'C04'

--12. Obtener  el nombre de los trabajadores que han participado en proyectos de la localidad de Jorge Chavez.

--solo de la tabla conductores
SELECT  C.NOMBRE, C.LOCALIDAD
FROM CONDUCTORES C 
WHERE  C.LOCALIDAD = 'JORGE CHAVEZ'

/*
SELECT * FROM CONDUCTORES
WHERE COD_COND = (SELECT COD_CONDUCTOR FROM   TRABAJOS 
WHERE COD_PROYECTO = (SELECT COD_PROY FROM PROYECTOS WHERE LOCALIDAD = '15 DE AGOSTO') 
AND COD_MAQUINA = (SELECT COD_MAQ FROM MAQUINAS WHERE NOMBRE = 'HORMIGONERA'))
*/

--de la tabla relacional, una forma coloquial pero que funciona
SELECT COD_PROY, LOCALIDAD
FROM PROYECTOS
WHERE LOCALIDAD = 'JORGE CHAVEZ'

SELECT COD_CONDUCTOR, COD_PROYECTO
FROM TRABAJOS 
WHERE COD_PROYECTO = 'P01' OR COD_PROYECTO = 'P03' OR COD_PROYECTO = 'P05'
ORDER BY COD_PROYECTO

SELECT NOMBRE, COD_COND
FROM CONDUCTORES 
WHERE COD_COND = 'C02' OR COD_COND = 'C05'

--13. Obtener del conductor de Jorge Chavez  que tenga la categoría más alta entre los que sean de Jorge Chavez

SELECT  *
FROM CONDUCTORES 
WHERE  LOCALIDAD = 'JORGE CHAVEZ' AND CATEGORIA IN (SELECT MAX(CATEGORIA) AS TOTAL_INGRESOS 
													FROM CONDUCTORES WHERE  LOCALIDAD = 'JORGE CHAVEZ')

/*14. Alterar la tabla "MÁQUINAS" para que almacene el consumo de combustible con el nombre: GALONES_HORA. Actualizar 
*sus valores con: 2.5, 1.5. 2 gal*/

ALTER TABLE MAQUINAS
ADD GALONES_HORA DECIMAL(10,2);

UPDATE MAQUINAS
SET GALONES_HORA = 2.5
WHERE COD_MAQ = 'M01';

UPDATE MAQUINAS
SET GALONES_HORA = 1.5
WHERE COD_MAQ = 'M02';

UPDATE MAQUINAS
SET GALONES_HORA = 2
WHERE COD_MAQ = 'M03';

SELECT * FROM MAQUINAS

--15. . Obtener el nombre de los conductores que hayan trabajado con una Hormigonera en proyectos de Jorge Chàvez.

SELECT  T.COD_CONDUCTOR, M.NOMBRE, P.LOCALIDAD
FROM TRABAJOS T, CONDUCTORES C, MAQUINAS M, PROYECTOS P
WHERE T.COD_MAQUINA = 'M02' AND M.NOMBRE = 'HORMIGONERA' AND P.LOCALIDAD = 'JORGE CHAVEZ'

SELECT  C.NOMBRE, M.NOMBRE AS 'NOMBRE DE MAQUINA'
FROM TRABAJOS T, CONDUCTORES C, MAQUINAS M
WHERE T.COD_MAQUINA = 'M02' AND T.COD_CONDUCTOR = C.COD_COND AND C.LOCALIDAD = 'JORGE CHAVEZ' AND T.COD_MAQUINA = M.COD_MAQ


SELECT  C.NOMBRE, M.NOMBRE AS 'NOMBRE DE MAQUINA', P.LOCALIDAD
FROM  CONDUCTORES C, MAQUINAS M, PROYECTOS P, TRABAJOS T
WHERE P.LOCALIDAD = 'JORGE CAHVEZ' AND T.COD_PROYECTO = P.COD_PROY AND M.COD_MAQ = 'M03' AND T.COD_MAQUINA = M.COD_MAQ


SELECT  C.NOMBRE AS 'NOMBRE DEL CONDUCTOR', M.NOMBRE AS 'NOMBRE DE MAQUINA'
FROM  CONDUCTORES C, MAQUINAS M, PROYECTOS P, TRABAJOS T
WHERE P.LOCALIDAD = 'JORGE CAHVEZ' AND T.COD_PROYECTO = P.COD_PROY AND M.COD_MAQ = 'M02' AND T.COD_MAQUINA = M.COD_MAQ

--forma que funciona; los de arriva son intentos 
SELECT * FROM CONDUCTORES
WHERE COD_COND = (SELECT COD_CONDUCTOR FROM  TRABAJOS 
WHERE COD_PROYECTO = (SELECT COD_PROY FROM PROYECTOS WHERE LOCALIDAD = 'JORGE CHAVEZ') 
AND COD_MAQUINA = (SELECT COD_MAQ FROM MAQUINAS WHERE NOMBRE = 'HORMIGONERA'))

SELECT * FROM TRABAJOS
SELECT * FROM CONDUCTORES
SELECT * FROM MAQUINAS
SELECT * FROM PROYECTOS
--16. Obtener el nombre del conductor y tiempo empleado para aquellos trabajos realizados el 10/06/2021

SELECT  C.NOMBRE, T.TIEMPO, T.FECHA
FROM CONDUCTORES C , TRABAJOS T
WHERE  T.COD_CONDUCTOR = C.COD_COND  AND T.FECHA = '2021/06/10'

--17. Modificar en el código de la tabla conductores  Manuel Díaz por  Humberto Romero

UPDATE  CONDUCTORES
SET NOMBRE = 'HUMBERTO ROMERO'
WHERE NOMBRE = 'MANUEL DIAZ'

SELECT * FROM MAQUINAS

/*18. Subir el precio por hora en un 10% del precio por hora más bajo -- para todas las máquinas 
*excepto para aquella que tenga el valor más alto.*/


SELECT  COD_MAQ, NOMBRE, PRECIO_HORA,
PRECIO_HORA + (PRECIO_HORA * 10/100) AS 'INCREMENTO DEL PRECIO EN UN 10%'
FROM MAQUINAS
WHERE PRECIO_HORA != (SELECT MAX(PRECIO_HORA) FROM MAQUINAS) 

--19. Qué conductores participaron en los trabajos de proyectos de  la localidad de Cristo_Rey

SELECT  P.LOCALIDAD,  C.NOMBRE
FROM TRABAJOS T, CONDUCTORES C, PROYECTOS P
WHERE T.COD_PROYECTO = 'P02' AND T.COD_CONDUCTOR = C.COD_COND AND P.LOCALIDAD = 'CRISTO REY'
--otra forma de hacer


--20  Obtener el nombre de los conductores que hayan trabajado con una Hormigonera en proyectos de 15 de agosto..

SELECT * FROM CONDUCTORES
WHERE COD_COND = (SELECT COD_CONDUCTOR FROM   TRABAJOS 
WHERE COD_PROYECTO = (SELECT COD_PROY FROM PROYECTOS WHERE LOCALIDAD = '15 DE AGOSTO') 
AND COD_MAQUINA = (SELECT COD_MAQ FROM MAQUINAS WHERE NOMBRE = 'HORMIGONERA'))

--21. Plantear  una consulta con vistas  que use join con 2 o tres tablas

CREATE VIEW CONDUC_PROYECTO AS 
SELECT  T.COD_PROYECTO, C.NOMBRE 
FROM CONDUCTORES C INNER JOIN TRABAJOS T 
ON T.COD_CONDUCTOR = C.COD_COND AND T.COD_PROYECTO = (SELECT COD_PROY FROM PROYECTOS WHERE LOCALIDAD = 'CRISTO REY')

SELECT * FROM CONDUC_PROYECTO